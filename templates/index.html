<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Selección de preferencias horarias</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
	<script src="https://unpkg.com/htmx.org@1.5.0"></script>
	<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
	<div>{{ ci }}</div>
	<div class="container mt-5">
		<div class="text-center mb-4">
			<h2>Seleccione su preferencia horaria</h2>
			<p class="lead">
				1 = más preferido &nbsp;&nbsp;•&nbsp;&nbsp; 3 = menos preferido &nbsp;&nbsp;•&nbsp;&nbsp; 0 = no
				disponible
			</p>
		</div>

		<form hx-post="/submit" hx-target="#confirmation" onsubmit="updatePreferences()" class="mb-4">
			<div class="table-responsive">
				<table class="table table-bordered table-hover text-center">
					<thead class="thead-dark">
						<tr>
							<th>Hora</th>
							{% for day in days_of_week %}
							<th>{{ day }}</th>
							{% endfor %}
						</tr>
					</thead>
					<tbody>
						{% for time in time_slots %}
						<tr>
							<td class="font-weight-bold align-middle">{{ time }}</td>
							{% for day in days_of_week %}
							<td class="time-slot align-middle" data-time="{{ time }}" data-day="{{ day }}"
								onclick="cyclePreference(this)">0</td>
							{% endfor %}
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>

			<input type="hidden" name="preferences" id="hidden-preferences">

			<div class="text-center">
				<button type="submit" class="btn btn-primary btn-lg mt-3">Enviar preferencias</button>
			</div>
		</form>

		<div id="confirmation" class="alert alert-success d-none text-center" role="alert">
			¡Preferencias enviadas correctamente!
		</div>
	</div>

	<script>
		// Cycle through preferences 0 to 3 on click
		function cyclePreference(cell) {
			let current = parseInt(cell.innerText);
			let newValue = (current + 1) % 4; // Cycle between 0 and 3
			cell.innerText = newValue;

			// Remove previous value classes
			cell.classList.remove('value-0', 'value-1', 'value-2', 'value-3');

			// Add new value class
			if (newValue !== 0) {
				cell.classList.add('value-' + newValue);
			}
		}

		// Prepare preferences data for submission
		function updatePreferences() {
			const preferences = {};

			// Collect all cells with preference values
			document.querySelectorAll('.time-slot').forEach(cell => {
				const time = cell.getAttribute('data-time');
				const day = cell.getAttribute('data-day');
				const value = parseInt(cell.innerText);

				// Initialize time slot entry if not present
				if (!preferences[time]) {
					preferences[time] = {};
				}
				preferences[time][day] = value;
			});

			// Update hidden input with JSON-encoded preferences
			document.getElementById('hidden-preferences').value = JSON.stringify(preferences);
		}
	</script>
</body>

</html>
